{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 14, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/Desktop/CRM/frontend/src/auth/tokenStore.ts"],"sourcesContent":["// src/auth/tokenStore.ts\r\n// In-memory access token store (never trust localStorage for security)\r\nlet accessToken: string | null = null;\r\n\r\nexport function getAccessToken() {\r\n  return accessToken;\r\n}\r\n\r\nexport function setAccessToken(token: string) {\r\n  accessToken = token;\r\n}\r\n\r\nexport function clearAccessToken() {\r\n  accessToken = null;\r\n}\r\n\r\n// If you must use localStorage (fallback), wrap with clear comments and centralize logic here.\r\nexport function loadTokenFromStorage() {\r\n  if (typeof window !== 'undefined') {\r\n    accessToken = localStorage.getItem('accessToken');\r\n  }\r\n}\r\n\r\nexport function saveTokenToStorage() {\r\n  if (typeof window !== 'undefined' && accessToken) {\r\n    localStorage.setItem('accessToken', accessToken);\r\n  }\r\n}\r\n\r\nexport function clearTokenFromStorage() {\r\n  if (typeof window !== 'undefined') {\r\n    localStorage.removeItem('accessToken');\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA,yBAAyB;AACzB,uEAAuE;AACvE,IAAI,cAA6B;AAE1B,SAAS;IACd,OAAO;AACT;AAEO,SAAS,eAAe,KAAa;IAC1C,cAAc;AAChB;AAEO,SAAS;IACd,cAAc;AAChB;AAGO,SAAS;IACd;;AAGF;AAEO,SAAS;IACd;;AAGF;AAEO,SAAS;IACd;;AAGF"}},
    {"offset": {"line": 56, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/Desktop/CRM/frontend/src/api/client.ts"],"sourcesContent":["// src/api/client.ts\r\nimport { getAccessToken, setAccessToken, clearAccessToken } from '../auth/tokenStore';\r\n\r\nconst API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';\r\n\r\nexport type ApiError = {\r\n  status: number;\r\n  message: string;\r\n};\r\n\r\nexport async function fetchWithAuth(input: RequestInfo, init: RequestInit = {}, retry = true): Promise<any> {\r\n  let token = getAccessToken();\r\n  const headers = new Headers(init.headers || {});\r\n  if (token) headers.set('Authorization', `Bearer ${token}`);\r\n  let url = typeof input === 'string' && /^https?:\\/\\//.test(input) ? input : `${API_BASE_URL}${input}`;\r\n  let res = await fetch(url, { ...init, headers, credentials: 'include' });\r\n  if (res.status === 401 && retry) {\r\n    // Try refresh\r\n    const refreshed = await refreshToken();\r\n    if (refreshed) {\r\n      token = getAccessToken();\r\n      headers.set('Authorization', `Bearer ${token}`);\r\n      res = await fetch(url, { ...init, headers, credentials: 'include' });\r\n    } else {\r\n      clearAccessToken();\r\n      throw { status: 401, message: 'Session expired' };\r\n    }\r\n  }\r\n  if (!res.ok) {\r\n    let message = 'Unknown error';\r\n    try { message = (await res.json()).message || message; } catch {}\r\n    throw { status: res.status, message };\r\n  }\r\n  if (res.status === 204) return null;\r\n  return res.json();\r\n}\r\n\r\nasync function refreshToken(): Promise<boolean> {\r\n  try {\r\n    // Try to get userId from token\r\n    const token = getAccessToken();\r\n    let userId = null;\r\n    if (token) {\r\n      // Decode JWT payload\r\n      try {\r\n        const payload = JSON.parse(atob(token.split('.')[1]));\r\n        userId = payload.sub;\r\n        console.log('refreshToken: decoded JWT payload', payload);\r\n        console.log('refreshToken: extracted userId', userId);\r\n      } catch (err) {\r\n        console.log('refreshToken: error decoding JWT', err);\r\n      }\r\n    }\r\n    const res = await fetch(`${API_BASE_URL}/auth/refresh`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      credentials: 'include',\r\n      body: JSON.stringify({ userId }),\r\n    });\r\n    if (!res.ok) return false;\r\n    const data = await res.json();\r\n    if (data.accessToken) {\r\n      setAccessToken(data.accessToken);\r\n      return true;\r\n    }\r\n    return false;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport const api = {\r\n  get: (url: string) => fetchWithAuth(url, { method: 'GET' }),\r\n  post: (url: string, body?: any) => fetchWithAuth(url, { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } }),\r\n  patch: (url: string, body?: any) => fetchWithAuth(url, { method: 'PATCH', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } }),\r\n  delete: (url: string) => fetchWithAuth(url, { method: 'DELETE' }),\r\n};\r\n\r\n// Typed helpers (example)\r\nexport async function login(email: string, password: string) {\r\n  return api.post('/auth/login', { email, password });\r\n}\r\n\r\nexport async function getMe(email: string) {\r\n  return api.post('/api/users/me', { email });\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/Desktop/CRM/frontend/src/auth/AuthProvider.tsx"],"sourcesContent":["// src/auth/AuthProvider.tsx\r\nimport React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';\r\nimport { getMe, login as apiLogin } from '../api/client';\r\nimport { getAccessToken, setAccessToken, clearAccessToken, loadTokenFromStorage, saveTokenToStorage, clearTokenFromStorage } from './tokenStore';\r\n\r\nexport type User = {\r\n  id: string;\r\n  email: string;\r\n  name: string;\r\n  role: 'ADMIN' | 'USER';\r\n};\r\n\r\ninterface AuthContextType {\r\n  user: User | null;\r\n  role: 'ADMIN' | 'USER' | null;\r\n  accessToken: string | null;\r\n  login: (email: string, password: string) => Promise<void>;\r\n  logout: () => void;\r\n  loading: boolean;\r\n  error: string | null;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport function AuthProvider({ children }: { children: ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [accessToken, setAccessTokenState] = useState<string | null>(getAccessToken());\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // On mount, try to load token from storage (if fallback is used)\r\n  useEffect(() => {\r\n    loadTokenFromStorage();\r\n    const token = getAccessToken();\r\n    if (token) setAccessTokenState(token);\r\n    bootstrapUser();\r\n    // eslint-disable-next-line\r\n  }, []);\r\n\r\n  async function bootstrapUser(email?: string) {\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      if (!email) {\r\n        setUser(null);\r\n        setLoading(false);\r\n        return;\r\n      }\r\n      const me = await getMe(email);\r\n      setUser(me);\r\n    } catch (err: any) {\r\n      setUser(null);\r\n      if (err.status === 401) clearAccessToken();\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function login(email: string, password: string) {\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const data = await apiLogin(email, password);\r\n      await bootstrapUser(email);\r\n    } catch (err: any) {\r\n      setError(err.message || 'Login failed');\r\n      setUser(null);\r\n      clearAccessToken();\r\n      clearTokenFromStorage();\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  function logout() {\r\n    setUser(null);\r\n    clearAccessToken();\r\n    clearTokenFromStorage();\r\n    setAccessTokenState(null);\r\n  }\r\n\r\n  return (\r\n    <AuthContext.Provider value={{ user, role: user?.role || null, accessToken, login, logout, loading, error }}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useAuth() {\r\n  const ctx = useContext(AuthContext);\r\n  if (!ctx) throw new Error('useAuth must be used within AuthProvider');\r\n  return ctx;\r\n}\r\n"],"names":[],"mappings":";;;;;;;AAAA,4BAA4B;AAC5B;AACA;AACA;;;;;AAmBA,MAAM,4BAAc,IAAA,kOAAa,EAA8B;AAExD,SAAS,aAAa,EAAE,QAAQ,EAA2B;IAChE,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,6NAAQ,EAAc;IAC9C,MAAM,CAAC,aAAa,oBAAoB,GAAG,IAAA,6NAAQ,EAAgB,IAAA,uJAAc;IACjF,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,6NAAQ,EAAC;IACvC,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,6NAAQ,EAAgB;IAElD,iEAAiE;IACjE,IAAA,8NAAS,EAAC;QACR,IAAA,6JAAoB;QACpB,MAAM,QAAQ,IAAA,uJAAc;QAC5B,IAAI,OAAO,oBAAoB;QAC/B;IACA,2BAA2B;IAC7B,GAAG,EAAE;IAEL,eAAe,cAAc,KAAc;QACzC,WAAW;QACX,SAAS;QACT,IAAI;YACF,IAAI,CAAC,OAAO;gBACV,QAAQ;gBACR,WAAW;gBACX;YACF;YACA,MAAM,KAAK,MAAM,IAAA,yIAAK,EAAC;YACvB,QAAQ;QACV,EAAE,OAAO,KAAU;YACjB,QAAQ;YACR,IAAI,IAAI,MAAM,KAAK,KAAK,IAAA,yJAAgB;QAC1C,SAAU;YACR,WAAW;QACb;IACF;IAEA,eAAe,MAAM,KAAa,EAAE,QAAgB;QAClD,WAAW;QACX,SAAS;QACT,IAAI;YACF,MAAM,OAAO,MAAM,IAAA,yIAAQ,EAAC,OAAO;YACnC,MAAM,cAAc;QACtB,EAAE,OAAO,KAAU;YACjB,SAAS,IAAI,OAAO,IAAI;YACxB,QAAQ;YACR,IAAA,yJAAgB;YAChB,IAAA,8JAAqB;QACvB,SAAU;YACR,WAAW;QACb;IACF;IAEA,SAAS;QACP,QAAQ;QACR,IAAA,yJAAgB;QAChB,IAAA,8JAAqB;QACrB,oBAAoB;IACtB;IAEA,qBACE,0PAAC,YAAY,QAAQ;QAAC,OAAO;YAAE;YAAM,MAAM,MAAM,QAAQ;YAAM;YAAa;YAAO;YAAQ;YAAS;QAAM;kBACvG;;;;;;AAGP;AAEO,SAAS;IACd,MAAM,MAAM,IAAA,+NAAU,EAAC;IACvB,IAAI,CAAC,KAAK,MAAM,IAAI,MAAM;IAC1B,OAAO;AACT"}},
    {"offset": {"line": 280, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/Desktop/CRM/frontend/src/routes/ProtectedRoute.tsx"],"sourcesContent":["// src/routes/ProtectedRoute.tsx\r\nimport { useAuth } from '../auth/AuthProvider';\r\nimport { useRouter } from 'next/navigation';\r\nimport { useEffect } from 'react';\r\n\r\ntype ProtectedRouteProps = {\r\n  children: React.ReactNode;\r\n  role?: 'ADMIN' | 'USER'; // if provided, restrict to this role\r\n};\r\n\r\nexport default function ProtectedRoute({ children, role }: ProtectedRouteProps) {\r\n  const { user, loading } = useAuth();\r\n  const router = useRouter();\r\n\r\n  useEffect(() => {\r\n    if (!loading) {\r\n      if (!user) {\r\n        router.replace('/login');\r\n      } else if (role && user.role !== role) {\r\n        router.replace('/no-access');\r\n      }\r\n    }\r\n  }, [user, loading, role, router]);\r\n\r\n  if (loading || !user || (role && user.role !== role)) {\r\n    return <div className=\"flex items-center justify-center h-full text-lg\">Loading...</div>;\r\n  }\r\n  return <>{children}</>;\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA,gCAAgC;AAChC;AACA;AAAA;AACA;;;;;AAOe,SAAS,eAAe,EAAE,QAAQ,EAAE,IAAI,EAAuB;IAC5E,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,GAAG,IAAA,mJAAO;IACjC,MAAM,SAAS,IAAA,8MAAS;IAExB,IAAA,8NAAS,EAAC;QACR,IAAI,CAAC,SAAS;YACZ,IAAI,CAAC,MAAM;gBACT,OAAO,OAAO,CAAC;YACjB,OAAO,IAAI,QAAQ,KAAK,IAAI,KAAK,MAAM;gBACrC,OAAO,OAAO,CAAC;YACjB;QACF;IACF,GAAG;QAAC;QAAM;QAAS;QAAM;KAAO;IAEhC,IAAI,WAAW,CAAC,QAAS,QAAQ,KAAK,IAAI,KAAK,MAAO;QACpD,qBAAO,0PAAC;YAAI,WAAU;sBAAkD;;;;;;IAC1E;IACA,qBAAO;kBAAG;;AACZ"}},
    {"offset": {"line": 329, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/Desktop/CRM/frontend/app/%28admin%29/page.tsx"],"sourcesContent":["import ProtectedRoute from '../../src/routes/ProtectedRoute';\r\n\r\nfunction AdminPageContent() {\r\n  return (\r\n    <div>\r\n      <h1>Admin</h1>\r\n      <div>Admin-only views (users, time, reports) will appear here.</div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function AdminPage() {\r\n  return (\r\n    <ProtectedRoute role=\"ADMIN\">\r\n      <AdminPageContent />\r\n    </ProtectedRoute>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;;;AAEA,SAAS;IACP,qBACE,0PAAC;;0BACC,0PAAC;0BAAG;;;;;;0BACJ,0PAAC;0BAAI;;;;;;;;;;;;AAGX;AAEe,SAAS;IACtB,qBACE,0PAAC,uJAAc;QAAC,MAAK;kBACnB,cAAA,0PAAC;;;;;;;;;;AAGP"}}]
}